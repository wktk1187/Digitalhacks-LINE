name: Send Daily LINE Messages

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ = UTC 0æ™‚
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  send-messages:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send LINE Messages via Supabase Edge Function
        run: |
          # line-auto-message-sender Edge Functionã‚’å‘¼ã³å‡ºã—
          echo "ğŸ”„ è‡ªå‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚’é–‹å§‹..."
          
          response=$(curl -s -w "%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/line-auto-message-sender" \
            -H "Content-Type: application/json")
          
          http_code="${response: -3}"
          response_body="${response%???}"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Edge Functionå®Ÿè¡ŒæˆåŠŸ"
            echo "$response_body" | jq '.'
          else
            echo "âŒ Edge Functionå®Ÿè¡Œå¤±æ•—: HTTP $http_code"
            echo "$response_body"
            exit 1
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}