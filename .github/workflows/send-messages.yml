name: Send Daily LINE Messages

on:
  schedule:
    # 毎日午前9時（JST）に実行 = UTC 0時
    - cron: '0 0 * * *'
  workflow_dispatch: # 手動実行も可能

jobs:
  send-messages:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send LINE Messages via Supabase Edge Function
        run: |
          # line-auto-message-sender Edge Functionを呼び出し
          echo "🔄 自動メッセージ送信を開始..."
          echo "📡 URL: ${SUPABASE_URL}/functions/v1/line-auto-message-sender"
          
          # curlでEdge Functionを呼び出し
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/line-auto-message-sender" \
            -H "Content-Type: application/json")
          
          # HTTPステータスコードと レスポンスボディを分離
          http_code=$(echo "$response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          response_body=$(echo "$response" | sed -e 's/HTTPSTATUS:.*//g')
          
          echo "📊 HTTP Status: $http_code"
          echo "📄 Response: $response_body"
          
          if [ "$http_code" = "200" ]; then
            echo "✅ Edge Function実行成功"
            echo "📨 メッセージ送信処理完了"
          else
            echo "❌ Edge Function実行失敗: HTTP $http_code"
            echo "🔍 レスポンス詳細: $response_body"
            exit 1
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}